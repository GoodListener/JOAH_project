<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<title>JOAH | by One Point</title>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/font-awesome.min.css" rel="stylesheet">
<link href="css/animate.min.css" rel="stylesheet">
<link href="css/main.css" rel="stylesheet">
<link href="css/responsive.css" rel="stylesheet">

<link rel="stylesheet" type="text/css" href="../lib/mycss/style_mypage.css" />
<link rel="stylesheet" type="text/css" href="../lib/mycss/style_header.css" />
<script type="text/javascript" src="../lib/myjs/modernizr.js"></script>

<script src="js/jquery-1.11.3.js"></script>
<script src="js/wow.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/main.js"></script>
</head>
<!--/head-->

<body>
<div id="main_container">
  <header id="h_title"></header>

<script>
$.ajax({
    url : "header.html",
    dataType : "html",
    type : "get",  // post 또는 get
    success : function(result){
        $("#h_title").html(result);
     }
});
</script>
	
  <div class="center_content_pages">
    <div class="pages_banner">MY PAGE</div>
  </div>
	
	<!-------Side Menu Bar 시작------>
	<section style="padding-top: 30px;">
	  <div class="row" id="row_mypage">
		<div id='cssmenu' class='col-xs-3'>
		  <ul id="menubar">
			<li><a><span>회원 정보</span></a>
			  <ul>
				<li><a href='mypage.html'><button class="menubar_button_c">커플 정보</button></a></li>
				<li><a href='my_filter.html'><button class="menubar_button">회원 정보 변경</button></a></li>
				<li><a href='my_pwd.html'><button class="menubar_button">비밀번호 변경</button></a></li>
				<li><a href='my_secession.html'><button class="menubar_button">회원 탈퇴</button></a></li>
			  </ul>
			</li>
			<li><a><span>마이 리스트</span></a>
			  <ul>
				<li><a href='#'><button class="menubar_button">나의 찜목록</button></a></li>
				<li><a href='my_ing.html'><button class="menubar_button">후기 미작성</button></a></li>
				<li><a href='my_board.html'><button class="menubar_button">내가 작성한 게시물</button></a></li>
			  </ul>
			</li>
			<li><a><span>문의</span></a>
			  <ul>
				<li><a href=''><span>1:1 문의</span></a></li>
		      </ul>
		    </li>
		  </ul>
		</div>
	<!-------Side Menu Bar 끝------>
	  <div class="col-xs-9">
		<div id="couple_info"></div>
		  <div id="couple">
		    <div class="col-xs-12">
 		      <label style="font-size: 30px; color: red;">커플 정보</label>
 		      <label>&#124;</label>
		      <label style="margin-top: 10px;">소중한 사람의 정보를 볼 수 있는 곳 입니다.</label>
		      <label style="margin-top: 10px;">너와 나의 </label>
			  <label style="color: skyblue;margin-top: 10px;"><b>가입 정보</b></label>
			  <label style="margin-top: 10px;">를 볼 수 있습니다.</label><br><br>
		    </div>   
		  </div>  
		  <div class="col-xs-12" style="margin-top: 20px;">
	        <div class="col-xs-6" style="position: relative;">
	          <div class="profile text-center">
	            <img src="../profile_image/default.jpg" class="img_mypage">
	          </div>	   
	          <div class="center_content">
	            <label style="margin: 15px 0 15px 0px; font-size: 30px; padding-left:20px;">내 정보</label>
	            <div class="sidebar blog-sidebar">
	              <div class="sidebar-item categories" style="position: ">
	                <ul class="nav navbar-stacked" style="margin-top:-5px;padding-top:3px;border-top: 3px solid #80828c;">
		              <li><a>ID<input id="member_id" style="border-radius:13px;"type="text" readonly></a></li>
		              <li><a>Name<input id="member_name" style="border-radius:13px;"type="text" readonly></a></li>
		              <li><a>E-Mail<input id="member_email" style="border-radius:13px;"type="text" readonly></a></li>
		              <li><a>Gender<input id="member_gender" style="border-radius:13px;"type="text" readonly></a></li>
		              <li><a>Age<input id="member_age" style="border-radius:13px;"type="text" readonly></a></li>
	                </ul>
	              </div>
	            </div>
	          </div>
	        </div>
	        <div class="col-xs-6" id="coupleCheck" style="position: relative;"></div>
		</div>     		        			
	</div>
</div>
</section>
</div>
<script>
var myName = '';
var coupleCheck = '';
var search = '';
var word = '';
if (location.href.indexOf('?') != -1) {
	search = location.href.split('?')[1].split('=')[1].split('&')[0];
	word = location.href.split('&')[1].split('=')[1];
}

$.getJSON('ajax/detailmember.do?id=' + sessionStorage.getItem('loginSession'), function(resultObj) {
  var ajaxResult = resultObj.ajaxResult;
  if (ajaxResult.status == "success") {
    var member = ajaxResult.data;
    /* $("#photo_div").html("<img src='images/portfolio/"+ member.photo +"' class='img-responsive' alt=''>") */
    $("#member_id").val(sessionStorage.getItem('loginSession'));
    $("#member_pwd").val(member.pwd);
    $("#member_name").val(member.name);
    myName = member.name;
    console.log(myName);
    $("#member_email").val(member.email);
    $("#member_gender").val(member.gender);
    $("#member_age").val(member.age);
    $("#member_cid").val(member.cid);
    coupleCheck = member.cid;
    console.log("coupleCheck : " + coupleCheck);
    
    
    if (coupleCheck === null || coupleCheck === '') {
    	$.getJSON('ajax/CR/requestCheck.do', function(resultObj){
		    for (var request of resultObj.data) {
		     if (request.my_id == sessionStorage.getItem('loginSession')) {
		    	 console.log("181818181818181818188");
		    	 var soloHeaven = $('#coupleCheck');
		    	 $('#coupleCheck')
		     	.html(
		     	  "<div>" + request.request_id +"님 께 커플신청중...</div>"
		     	+ "<button type='button' id='cancleCouple'>커플 신청 취소</button>").appendTo(soloHeaven);
		    	 
		    	 $('#cancleCouple').click(
		 				function(event) {
		 					var my_Id = sessionStorage.getItem('loginSession')
		 					$.getJSON('ajax/CR/delete.do?my_id=' + my_Id, function(resultObj) {
		 						console.log("커플신청 취소함.");
		 						var ajaxResult = resultObj.ajaxResult;
		 						if (ajaxResult.status == "success") {
		 							alert("커플 신청 취소 성공.");
		 							location.href = "mypage.html";
		 						} else {
		 							alert("커플 신청 중이 아닙니다.");
		 						}
		 					})
		 				});
		     } else if (request.request_id == sessionStorage.getItem('loginSession')) {
		    	 console.log("111111111111118");
		    	 var soloHeaven = $('#coupleCheck');
		    	 $('#coupleCheck')
		     	.html(
		         + "<div>" + request.my_id +"님 께서 커플신청을 하셨습니다...</div>"
		         + "<button type='button' id='acceptBtn'>커플 수락</button>"
		         + "<button type='button' id='rejectBtn'>커플 거절</button>"		
		         ).appendTo(soloHeaven);
		    	 
		    	 /* $('#acceptBtn').click(
			 				function(event) {
			 					var my_Id = sessionStorage.getItem('loginSession')
			 					$.getJSON('ajax/CR/reject.do?request_id=' + my_Id, function(resultObj) {
			 						console.log("커플신청 거절함.");
			 						var ajaxResult = resultObj.ajaxResult;
			 						if (ajaxResult.status == "success") {
			 							alert("커플 신청 거절 성공.");
			 							location.href = "mypage.html";
			 						} else {
			 							alert("오류!");
			 						}
			 					})
			 				}); */
		    	 
		    	 $('#rejectBtn').click(
		 				function(event) {
		 					var my_Id = sessionStorage.getItem('loginSession')
		 					$.getJSON('ajax/CR/reject.do?request_id=' + my_Id, function(resultObj) {
		 						console.log("커플신청 거절함.");
		 						var ajaxResult = resultObj.ajaxResult;
		 						if (ajaxResult.status == "success") {
		 							alert("커플 신청 거절 성공.");
		 							location.href = "mypage.html";
		 						} else {
		 							alert("오류!");
		 						}
		 					})
		 				});
		    	 
		     }
		     else {
		    	 
      	var soloHeaven = $('#coupleCheck');
    	
    	$('#coupleCheck')
    	.html(
    	   "<div>"
 		 + "<form id='form1'>"
		 + "<select name='search'>"
		 + "<option value='id'>아이디</option>"
		 + "</select>"
		 + "<input type='text' name='word'>"
		 + "<input type='submit' value='검색'>"
		 + "</form></div><br><br><div id='searchSolo'></div>"
		 + "<div class='center_content search_id'></div>"
         + "<button type='button' id='requestCouple'>커플 신청</button>"
         + "<button type='button' id='cancleCouple'>커플 신청 취소</button>"
         ).appendTo(soloHeaven);
    	
    	$('#cancleCouple').click(
				function(event) {
					var my_Id = sessionStorage.getItem('loginSession')
					$.getJSON('ajax/CR/delete.do?my_id=' + my_Id, function(resultObj) {
						console.log("커플신청 취소함.");
						var ajaxResult = resultObj.ajaxResult;
						if (ajaxResult.status == "success") {
							alert("커플 신청 취소 성공.");
							location.href = "mypage.html";
						} else {
							alert("커플 신청 중이 아닙니다.");
						}
					})
				});
		     }
    	
    	
		    } // for문 끝
    	}); // checkRequest 끝.
    	
    } else {
    	
    	$.getJSON('ajax/member/coupleinfo.do?id=' + coupleCheck, function(resultObj) {
   		 console.log("coupleCheck2 : " + coupleCheck);	
   		var ajaxResult = resultObj.ajaxResult;
   		var coupleHell = $('#coupleCheck')
   		console.log(resultObj.ajaxResult);
   		if (ajaxResult.status == "success") {
   			
   			$('#coupleCheck')
   			.html(
   			   "<div class='profile text-center'>"
   		     + "<img class='img_mypage'></div>" 
   	         + "<div class='center_content'>"
   	         + "<label style='margin: 15px 0 15px 0px; font-size: 30px; padding-left:20px;'>애인 정보</label>"
   	         + "<div class='sidebar blog-sidebar'>"
   	         + "<div class='sidebar-item categories' style='position:'>"
   	         + "<ul class='nav navbar-stacked' style='margin-top:-5px;padding-top:3px;border-top: 3px solid #80828c;'>"
   		     + "<li><a>ID<input id='couple_id' style='border-radius:13px;'type='text' readonly></a></li>"
   		     + "<li><a>Name<input id='couple_name' style='border-radius:13px;'type='text'readonly></a></li>"
   		     + "<li><a>E-Mail<input id='couple_email' style='border-radius:13px;'type='text' readonly></a></li>"
   		     + "<li><a>Gender<input id='couple_gender' style='border-radius:13px;'type='text' readonly></a></li>"
   		     + "<li><a>Age<input id='couple_age' style='border-radius:13px;'type='text' readonly></a></li>"
   	         + "</ul></div></div></div>").appendTo(coupleHell);
   			
   			 var couple = ajaxResult.data;
   			 console.log(ajaxResult.data);
   			 $("#couple_id").val(couple.id);
   			 $("#couple_name").val(couple.name);
   			 $("#couple_email").val(couple.email);
   			 $("#couple_gender").val(couple.gender);
   			 $("#couple_age").val(couple.age);
   			 $(".img_mypage").attr("src", "../profile_image/"+member.photo);
   		}	
   	});
    }
  }
  
  if (word != '' && search !='') {
		$.getJSON('ajax/coupleSearch.do?search=' + search + '&word=' + word , function(resultObj) {
			var search_Solo = $('#searchSolo');
			 for (var member of resultObj.data) {
				 console.log(member);
				$("#searchSolo")
				.html("<label style='margin: 15px 0 15px 0px; font-size: 30px; padding-left:20px;'/>검색 정보</label><br><br><br>"
					+ "<div class='profile text-center'>"	
					+ "<div class='sidebar-item categories' style='position:'>"
		            + "<ul class='nav navbar-stacked' style='margin-top:-5px;padding-top:3px;border-top: 3px solid #80828c;'><br><br>"
		            + "<br><br><img src='../profile_image/" + member.photo +"' class='img_mypage' alt=''>"
		            + "</div><div>아이디(이름) : "
		            + "<input value='     "  + member.id  + "(" + member.name + ")' style='border-radius:13px;'type='text' readonly></div><br>"
		            + "<div>나이 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<input value='           "  + member.age  
		            + "' style='border-radius:13px;'type='text' readonly></div><br>"
		            ).appendTo(search_Solo);
			 }
			 
			 $('#requestCouple').click(function(event) {
					
					var my_Id = sessionStorage.getItem('loginSession');
					var IdCheck = 0; // 1 이면 커플신청중임 0이면 커플 신청중 아님.
					var CidCheck = 0; //1 이면 상대방이 이미 커플이 있음. 0이면 상대방이 커플이 없음.
					
					console.log("상대방아이디 - " + word);
					console.log("내이메일 - " + my_Id);
					
					if (word == sessionStorage.getItem('loginSession') ) {
						console.log("아무리 외로워도 본인과 커플 ㄴㄴ ");
						alert('본인에게 커플 신청을 할 수 없습니다.');
					} else {
						
						$.getJSON('ajax/couplecheck.do', function(resultObj){
						    for (var member of resultObj.data) {
						    	if (member.id == word) {
						    		
						    		if ((member.cid == null || member.cid == '')) {
						    			
						    			console.log("나는 커플이 없따 ㅠㅠ!!!");
						    			console.log(member);
						    			
						    			$.getJSON('ajax/CR/idcheck.do', function(resultObj){
						    			    for (var couple_request of resultObj.data) {
						    			      if(my_Id == couple_request.my_id){
						    			    	  IdCheck = 1;
						    			      }
						    			    }
						    			    console.log(IdCheck);
						    			    if (IdCheck!=1) {
						    				    	$.post('ajax/CR/add.do', {	
						    						my_id : my_Id,
						    						my_name : myName,
						    						request_id : word,
						    					    }, function(resultObj) {
						    						var ajaxResult = resultObj.ajaxResult;
						    						if (ajaxResult.status == "success") {
						    							alert("커플 신청 성공.");
						    							location.href = "mypage.html";
						    						} else {
						    							alert("오류!!!!");
						    						}
						    					}, 'json');  
						    			    } else {
						    			    	alert("커플 신청중 입니다. 커플 신청을 취소하고 다시 신청해주세요.");
						    			    }
						    			})
						    			
						    		} else {
						    			console.log("나는 커플이 있따!!!");
						    			console.log(member);
						    			alert("상대방은 이미 커플중입니다..");
						    		}
						    	} 
						    }
						 })
					}
				});
		});
		
		
	}
}); 








</script>
</body>
</html>